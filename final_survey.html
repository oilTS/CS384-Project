<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>แบบสอบถามท้ายการทดลอง</title>
<link rel="stylesheet" href="style.css">
<script src="main.js"></script>
</head>

<body>

<h2>แบบสอบถามหลังเสร็จสิ้นการทดลอง</h2>

<p class="notice">กรุณาตอบข้อ 1–4 ให้ครบ (เป็นช้อยส์ 1–5)</p>

<form id="surveyForm">

    <div class="question-block">
        <p><b>1) สุนทรียภาพจากการอ่าน</b></p>
        <label><input type="radio" name="q1" value="1"> 1</label><br>
        <label><input type="radio" name="q1" value="2"> 2</label><br>
        <label><input type="radio" name="q1" value="3"> 3</label><br>
        <label><input type="radio" name="q1" value="4"> 4</label><br>
        <label><input type="radio" name="q1" value="5"> 5</label>
    </div>

    <hr>

    <div class="question-block">
        <p><b>2) สุนทรียภาพจากการฟัง</b></p>
        <label><input type="radio" name="q2" value="1"> 1</label><br>
        <label><input type="radio" name="q2" value="2"> 2</label><br>
        <label><input type="radio" name="q2" value="3"> 3</label><br>
        <label><input type="radio" name="q2" value="4"> 4</label><br>
        <label><input type="radio" name="q2" value="5"> 5</label>
    </div>

    <hr>

    <div class="question-block">
        <p><b>3) ความเข้าใจจากการอ่าน</b></p>
        <label><input type="radio" name="q3" value="1"> 1</label><br>
        <label><input type="radio" name="q3" value="2"> 2</label><br>
        <label><input type="radio" name="q3" value="3"> 3</label><br>
        <label><input type="radio" name="q3" value="4"> 4</label><br>
        <label><input type="radio" name="q3" value="5"> 5</label>
    </div>

    <hr>

    <div class="question-block">
        <p><b>4) ความเข้าใจจากการฟัง</b></p>
        <label><input type="radio" name="q4" value="1"> 1</label><br>
        <label><input type="radio" name="q4" value="2"> 2</label><br>
        <label><input type="radio" name="q4" value="3"> 3</label><br>
        <label><input type="radio" name="q4" value="4"> 4</label><br>
        <label><input type="radio" name="q4" value="5"> 5</label>
    </div>

    <hr>

    <div class="question-block">
        <p><b>5) ข้อเสนอแนะเพิ่มเติม (ไม่บังคับ)</b></p>
        <textarea id="feedback" style="width:100%; height:120px;"></textarea>
    </div>

</form>

<p id="err" class="error"></p>

<button id="submitBtn">ส่งแบบสอบถาม</button>

<script>
document.getElementById("submitBtn").onclick = () => {

    let requiredOK = true;

    ["q1","q2","q3","q4"].forEach(name => {
        const v = document.querySelector(`input[name="${name}"]:checked`);
        if (!v) requiredOK = false;
    });

    if (!requiredOK) {
        document.getElementById("err").textContent =
            "กรุณาตอบข้อ 1–4 ให้ครบทุกข้อ";
        return;
    }

    // --- รวบรวมข้อมูลทั้งหมดและส่ง ---
    const set = window.Experiment.getParam("set");
    let finalData = window.Experiment.loadExperimentData();
    
    // 1. ดึงข้อมูลจาก Survey
    finalData.q1 = document.querySelector('input[name="q1"]:checked').value;
    finalData.q2 = document.querySelector('input[name="q2"]:checked').value;
    finalData.q3 = document.querySelector('input[name="q3"]:checked').value;
    finalData.q4 = document.querySelector('input[name="q4"]:checked').value;
    finalData.feedback = document.getElementById("feedback").value;

    // 2. เพิ่ม Set เข้าไปใน Data ที่จะส่ง
    finalData.set = set; 

    // 3. จัดการ Field ที่ขาดหายไป (ถ้า Set S1 เป็น Read/Listen)
    // ทำให้แน่ใจว่าส่งครบทุก Field ตาม Apps Script
    
    // Field ที่อาจจะว่างถ้าไม่ได้ทดลอง (เช่น S1 ไม่ทำ Read P2)
    finalData.read_time_P2 = finalData.read_time_P2 || null; 
    finalData.read_score_P2 = finalData.read_score_P2 || null;
    finalData.listen_time_P2 = finalData.listen_time_P2 || null;
    finalData.listen_score_P2 = finalData.listen_score_P2 || null;
    
    // Field P1 (สำหรับ Set S3/S4 ที่เริ่มด้วย Listen)
    finalData.read_time = finalData.read_time || null;
    finalData.read_score = finalData.read_score || null;
    finalData.listen_time = finalData.listen_time || null;
    finalData.listen_score = finalData.listen_score || null;

    // 4. ส่งข้อมูลไป Google Sheets
    window.Experiment.sendToSheet(finalData);

    // 5. ล้างข้อมูล Local Storage เมื่อส่งเสร็จ
    window.Experiment.clearExperimentData();
    // -------------------------------------

    document.body.innerHTML = `
        <h2 style="color:green;">ส่งข้อมูลเรียบร้อย ขอบคุณค่ะ</h2>
    `;
};
</script>

</body>
</html>