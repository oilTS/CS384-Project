<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>แบบทดสอบ (Phase 1)</title>
<link rel="stylesheet" href="style.css">
<script src="main.js"></script>
</head>

<body>
<h2>แบบทดสอบความเข้าใจ (Phase 1)</h2>

<div id="quiz-container"></div>

<p id="err" class="error"></p>

<button id="submitBtn">ส่งคำตอบ</button>

<script>
(function(){
    // 1. ดึงพารามิเตอร์จาก URL
    const set = window.Experiment.getParam("set");
    const articleLetter = window.Experiment.getParam("article"); // รับค่า A หรือ B
    const containerId = "quiz-container";

    // 2. ตรวจสอบข้อมูลก่อนรัน
    if (!set || !articleLetter) {
        document.getElementById(containerId).innerHTML = "<p>เกิดข้อผิดพลาด: ไม่พบรหัสชุดทดสอบหรือบทความ</p>";
        return;
    }

    // 3. สร้างโจทย์ (เรียกฟังก์ชันจาก main.js)
    window.Experiment.renderQuiz(articleLetter, containerId); 

    // 4. เมื่อกดส่งคำตอบ
    document.getElementById("submitBtn").onclick = () => {
        // 4.1 ตรวจสอบคำตอบและคิดคะแนน (เรียกฟังก์ชันจาก main.js)
        const result = window.Experiment.validateQuizAnswers(articleLetter, containerId);

        if (!result.ok) {
            document.getElementById("err").textContent = "กรุณาตอบทุกข้อก่อนส่ง";
            return; // หยุดถ้าตอบไม่ครบ
        }

        // 4.2 โหลดข้อมูลเดิมและบันทึกคะแนนใหม่
        const data = window.Experiment.loadExperimentData();
        
        // เช็คเงื่อนไขจาก main.js ว่า Phase 1 เป็น "read" หรือ "listen"
        const conditionObj = window.Experiment.CONDITION[set];
        if (!conditionObj) {
            alert("ไม่พบข้อมูลเงื่อนไขสำหรับ Set: " + set);
            return;
        }

        const isRead = conditionObj.first.startsWith("read");
        
        if (isRead) {
            data.read_score = result.score;
            data.read_article = articleLetter; // บันทึกว่าอ่านเรื่องอะไร
        } else {
            data.listen_score = result.score;
            data.listen_article = articleLetter; // บันทึกว่าฟังเรื่องอะไร
        }
        
        // บันทึกกลับลง LocalStorage
        window.Experiment.saveExperimentData(data);

        // 4.3 นำทางไปยัง Phase 2 (ตรวจสอบเงื่อนไขช่วงที่ 2)
        const nextCondition = conditionObj.second; // เช่น "listenB" หรือ "readA"

        if (nextCondition.startsWith("read")) {
            // ถ้า Phase 2 เป็นการอ่าน
            const letter = nextCondition.endsWith("A") ? "A" : "B";
            window.location = `phase2_read_ready.html?set=${set}&article=${letter}`;
        } else {
            // ถ้า Phase 2 เป็นการฟัง
            const letter = nextCondition.endsWith("A") ? "A" : "B";
            window.location = `phase2_listen_ready.html?set=${set}&audio=${letter}`;
        }
    };
})();
</script>

</body>
</html>