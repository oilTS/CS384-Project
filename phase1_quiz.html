<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>แบบทดสอบ</title>
<link rel="stylesheet" href="style.css">
<script src="main.js"></script>
</head>

<body>
<h2>แบบทดสอบความเข้าใจ (Phase 1)</h2>

<div id="quiz-container"></div>

<p id="err" class="error"></p>

<button id="submitBtn">ส่งคำตอบ</button>

<script>
(function(){
    const set = window.Experiment.getParam("set");
    const articleLetter = window.Experiment.getParam("article"); // A หรือ B
    const containerId = "quiz-container";

    window.Experiment.renderQuiz(articleLetter, containerId); 

    document.getElementById("submitBtn").onclick = () => {
        // ใช้ฟังก์ชันใหม่ในการตรวจสอบและคิดคะแนน
        const result = window.Experiment.validateQuizAnswers(articleLetter, containerId);

        if (!result.ok) {
            document.getElementById("err").textContent = "กรุณาตอบทุกข้อก่อนส่ง";
            return;
        }

        // --- บันทึกข้อมูลคะแนน Phase 1 ---
        const data = window.Experiment.loadExperimentData();
        
        // ตรวจสอบว่า Phase 1 เป็น อ่าน หรือ ฟัง
        const isRead = window.Experiment.CONDITION[set].first.startsWith("read");
        
        if (isRead) {
            data.read_score = result.score;
            data.read_article = articleLetter; // บันทึกบทความที่อ่าน
        } else {
            data.listen_score = result.score;
            data.listen_article = articleLetter; // บันทึกบทความที่ฟัง
        }
        
        window.Experiment.saveExperimentData(data);
        // ---------------------------------

        // ไปหน้าถัดไป (Phase 2)
        const nextCondition = window.Experiment.CONDITION[set].second;

        if (nextCondition.startsWith("read")) {
            const letter = nextCondition.endsWith("A") ? "A" : "B";
            window.location = `phase2_read_ready.html?set=${set}&article=${letter}`;
        } else {
            const letter = nextCondition.endsWith("A") ? "A" : "B";
            window.location = `phase2_listen_ready.html?set=${set}&audio=${letter}`;
        }
    };
})();
</script>

</body>
</html>