<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>แบบทดสอบ (Phase 2)</title>
<link rel="stylesheet" href="style.css">
<script src="main.js"></script>
</head>

<body>
<h2>แบบทดสอบความเข้าใจ (Phase 2)</h2>

<div id="quiz-container"></div>

<p id="err" class="error"></p>

<button id="submitBtn">ส่งคำตอบ</button>

<script>
(function(){
    // 1. ดึงพารามิเตอร์จาก URL
    const set = window.Experiment.getParam("set");
    const articleLetter = window.Experiment.getParam("article"); 
    const containerId = "quiz-container";

    // 2. ตรวจสอบข้อมูลก่อนรัน
    if (!set || !articleLetter) {
        document.getElementById(containerId).innerHTML = "<p>เกิดข้อผิดพลาด: ไม่พบรหัสชุดทดสอบหรือบทความ</p>";
        return;
    }

    // 3. สร้างโจทย์ (เรียกฟังก์ชันจาก main.js)
    window.Experiment.renderQuiz(articleLetter, containerId); 

    // 4. เมื่อกดส่งคำตอบ
    document.getElementById("submitBtn").onclick = () => {
        // 4.1 ตรวจสอบคำตอบและคิดคะแนน
        const result = window.Experiment.validateQuizAnswers(articleLetter, containerId);

        if (!result.ok) {
            document.getElementById("err").textContent = "กรุณาตอบทุกข้อก่อนส่ง";
            return;
        }

        // 4.2 โหลดข้อมูลเดิมและบันทึกคะแนน Phase 2
        const data = window.Experiment.loadExperimentData();
        
        // ตรวจสอบเงื่อนไขช่วงที่ 2 (Phase 2) ของ Set นี้
        const conditionObj = window.Experiment.CONDITION[set];
        if (!conditionObj) {
            alert("ไม่พบข้อมูลเงื่อนไขสำหรับ Set: " + set);
            return;
        }
        
        const nextCondition = conditionObj.second; // ช่วงที่ 2

        if (nextCondition.startsWith("read")) {
            // ถ้า Phase 2 เป็นการอ่าน -> บันทึกในตัวแปร P2 Read
            data.read_score_P2 = result.score;
            data.read_article_P2 = articleLetter;
        } else {
            // ถ้า Phase 2 เป็นการฟัง -> บันทึกในตัวแปร P2 Listen
            data.listen_score_P2 = result.score;
            data.listen_article_P2 = articleLetter;
        }
        
        // บันทึกกลับลง LocalStorage
        window.Experiment.saveExperimentData(data);

        // 4.3 จบ Phase 2 เสมอ -> ไปหน้า Survey (พร้อมส่งรหัส set ไปด้วย)
        window.location = `final_survey.html?set=${set}`;
    };
})();
</script>

</body>
</html>